# Temporary file to confirm GitHub App token and secret

name: Test GitHub App
on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Manual JWT generation (debug)
        run: |
          # Save private key to file
          echo "${{ secrets.HFLA_WORKFLOW_APP_PRIVATE_KEY }}" > private-key.pem
          
          # Check if file is valid
          if openssl rsa -in private-key.pem -check -noout; then
            echo "✓ Private key file is valid"
          else
            echo "✗ Private key file is invalid"
            exit 1
          fi
          
          # Clean up
          rm private-key.pem
    
      - name: Debug secrets format
        run: |
          echo "App ID length: ${#HFLA_WORKFLOW_APP_ID}"
          echo "App ID starts with: ${HFLA_WORKFLOW_APP_ID:0:3}"
          echo "Private key length: ${#HFLA_WORKFLOW_APP_PRIVATE_KEY}"
          echo "Private key starts with: ${HFLA_WORKFLOW_APP_PRIVATE_KEY:0:30}"
          echo "Private key ends with: ${HFLA_WORKFLOW_APP_PRIVATE_KEY: -30}"
        env:
          HFLA_WORKFLOW_APP_ID: ${{ secrets.HFLA_WORKFLOW_APP_ID }}
          HFLA_WORKFLOW_APP_PRIVATE_KEY: ${{ secrets.HFLA_WORKFLOW_APP_PRIVATE_KEY }}
    
      - name: Generate token from GitHub App
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.HFLA_GRAPHQL_APP_ID }}
          private-key: ${{ secrets.HFLA_GRAPHQL_APP_PRIVATE_KEY }}
      
      - name: Use the token to make a test API call
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          echo "Testing if token works by fetching repo info..."
          gh api /repos/${{ github.repository }}
          echo "Success! GRAPHQL token is working."

      - name: Generate token from GitHub App
        id: generate_other_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.HFLA_WORKFLOW_APP_ID }}
          private-key: ${{ secrets.HFLA_WORKFLOW_APP_PRIVATE_KEY }}
          
      - name: Debug - Check App Installation
        env:
          GH_TOKEN: ${{ steps.generate_other_token.outputs.token }}
        run: |
          echo "Checking if GitHub App is installed on hackforla/website..."
          if gh api /repos/hackforla/website/installation --jq '.id' 2>&1; then
            echo "✅ GitHub App is installed"
          else
            echo "❌ GitHub App is NOT installed on hackforla/website"
            echo "Go to: https://github.com/organizations/hackforla/settings/installations"
            echo "And ensure the app has access to hackforla/website"
            exit 1
          fi
          
      - name: Use the token to make a test API call
        env:
          GH_TOKEN: ${{ steps.generate_other_token.outputs.token }}
        run: |
          echo "Testing if token works by fetching repo info..."
          gh api /repos/${{ github.repository }}
          echo "Success! WORKFLOW token is working."
          
      - name: Debug GitHub App Access
        env:
          APP_TOKEN: ${{ steps.generate_other_token.outputs.token }}
        run: |
          echo "Testing GitHub App access..."
          export GH_TOKEN="$APP_TOKEN"
          
          # Test API access
          echo "Attempting to access hackforla/website via API..."
          gh api repos/hackforla/website --jq '.full_name,.permissions' || echo "API access failed"
          
          # Show token metadata (without exposing the token)
          echo "Token starts with: ghs_..." 
          echo "Token length: ${#APP_TOKEN}"
