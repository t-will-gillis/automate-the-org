name: Rollout Workflow to Project(s)

on:
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'Provide a comma-separated list of the target project/repos (e.g. "hackforla/project1", "hackforla/project2")'
        required: true
        type: string
      rollout_branch:
        description: 'Branch name created for PR for rollout'
        required: false
        default: 'rollout-add-central-workflow'
      dry_run:
        description: 'Dry-run mode: preview changes without creating PRs'
        type: boolean
        default: true

jobs:
  rollout:
    runs-on: ubuntu-latest

    steps:
      - name: Generate token from GitHub App
        id: generate-app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.HFLA_WORKFLOW_APP_ID }}
          private-key: ${{ secrets.HFLA_WORKFLOW_APP_PRIVATE_KEY }}

      - name: Prepare variables
        run: |
          echo "TARGET_REPOS=${{ github.event.inputs.target_repos }}" >> $GITHUB_ENV
          echo "ROLL_OUT_BRANCH=${{ github.event.inputs.rollout_branch }}" >> $GITHUB_ENV
          echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_ENV

      - name: Checkout the source workflows repo
        uses: actions/checkout@v5
        with:
          repository: hackforla/automate-the-org
          path: central

      - name: Extract rollout config from PR template
        id: parse-config
        run: |
          # Extract YAML block from .github/templates/pr_template.md into a temp YAML file
          awk '/^```yaml/{flag=1;next}/^```$/{flag=0}flag' central/.github/templates/pr_template.md > rollout-config.yaml

          echo "---- rollout-config.yaml ----"
          cat rollout-config.yaml
          echo "-----------------------------"

          # Parse workflow file mapping
          WORKFLOW_SRC=$(yq -r '.workflow_file.src' rollout-config.yaml)
          WORKFLOW_DEST=$(yq -r '.workflow_file.dest' rollout-config.yaml)
          echo "WORKFLOW_SRC=$WORKFLOW_SRC" >> $GITHUB_ENV
          echo "WORKFLOW_DEST=$WORKFLOW_DEST" >> $GITHUB_ENV

          # Parse config_files into JSON for iteration
          yq -o=json '.config_files' rollout-config.yaml > config_files.json
          echo "Parsed config_files.json:"
          cat config_files.json

      - name: Extract workflow name from workflow source
        run: |
          # The workflow source is relative to the central repo checkout
          WORKFLOW_NAME=$(grep -E '^name:' "$WORKFLOW_SRC" | sed 's/^name:[[:space:]]*//')
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "Workflow name: $WORKFLOW_NAME"

      - name: Rollout to each repo
        env:
          APP_TOKEN: ${{ steps.generate-app-token.outputs.token }} 
        run: |
          IFS=',' read -ra REPOS <<< "$TARGET_REPOS"
          for REPO in "${REPOS[@]}"; do
            echo "Processing repo: $REPO . . ."

            # ⓵ Get default branch
            DEFAULT_BRANCH=$(gh api repos/$REPO --jq '.default_branch' -H "Authorization: token $APP_TOKEN")
            echo "Default branch: $DEFAULT_BRANCH"

            # Only in 'DRY_RUN'mode
            if [ "$DRY_RUN" = "true" ]; then
              echo "[DRY-RUN] Would clone repo: $REPO (branch: $DEFAULT_BRANCH)"
              echo "[DRY-RUN] Would create branch: $ROLL_OUT_BRANCH"
              echo "[DRY-RUN] Would copy workflow file: $WORKFLOW_SRC -> $WORKFLOW_DEST"
              
              # list config copies
              if [ -s config_files.json ]; then
                cat config_files.json | jq -c '.[]' | while read -r item; do
                  SRC=$(echo "$item" | jq -r '.src')
                  DEST=$(echo "$item" | jq -r '.dest')
                  echo "[DRY-RUN] Would copy config file: $SRC -> $DEST"
                done
              else
                echo "[DRY-RUN] No config files listed."
              fi

              echo "[DRY-RUN] Would commit changes: Install ${WORKFLOW_NAME} and project-specific files"
              echo "[DRY-RUN] Would push branch: $ROLL_OUT_BRANCH"
              
              # read PR template for preview
              PR_BODY=$(cat .github/templates/pr-template.md)
              echo "[DRY-RUN] PR body preview:"
              echo "----------------------------------"
              echo "$PR_BODY"
              echo "----------------------------------"

              echo "[DRY-RUN] Would create PR titled: Install workflow: ${WORKFLOW_NAME}"
              continue
            fi

            # ⓶ Continue with clone default branch
            git clone --depth 1 --branch "$DEFAULT_BRANCH" https://x-access-token:${APP_TOKEN}@github.com/${REPO} temp-repo
            cd temp-repo

            # ⓷ Create rollout branch
            git checkout -b "$ROLL_OUT_BRANCH"

            # ⓸ Copy workflow file (from central checkout, WORKFLOW_SRC is relative to central repo)
            mkdir -p "$(dirname "$WORKFLOW_DEST")"
            cp "../$WORKFLOW_SRC" "$WORKFLOW_DEST"
            echo "Copied workflow: $WORKFLOW_SRC -> $WORKFLOW_DEST"

            # ⓹ Copy project-specific config files (from parsed JSON)
            if [ -s ../config_files.json ]; then
              cat ../config_files.json | jq -c '.[]' | while read -r item; do
                SRC=$(echo "$item" | jq -r '.src')
                DST=$(echo "$item" | jq -r '.dest')
                mkdir -p "$(dirname "$DST")"
                cp "../$SRC" "$DST"
                echo "Copied config: $SRC -> $DST"
              done
            fi

            # ⓺ Commit changes
            git config user.name "Central Rollout Bot"
            git config user.email "rollout-bot@hackforla.org"
            git add .
            git commit -m "Install ${WORKFLOW_NAME} and project-specific files"

            # ⓻ Push rollout branch
            git push origin "$ROLL_OUT_BRANCH"

            # ⓼ Create Pull Request
            PR_BODY=$(cat ../.github/templates/pr-template.md)

            # Substitute placeholders if needed (example replacements)
            PR_BODY=$(echo "$PR_BODY" \
              | sed "s/{{WORKFLOW_NAME}}/${WORKFLOW_NAME}/g" \
              | sed "s/{{TRIGGERED_BY}}/@${{ github.actor }}/g" \
              | sed "s/{{TIMESTAMP}}/$(date -u +"%Y-%m-%dT%H:%M:%SZ")/g"
            )

            gh pr create \
              --repo $REPO \
              --head "$ROLL_OUT_BRANCH" \
              --base "$DEFAULT_BRANCH" \
              --title "Install workflow: ${WORKFLOW_NAME}" \
              --body "$PR_BODY"


            # Cleanup for next repo
            cd ..
            rm -rf temp-repo
          done
